<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restaurant The Kitchen ‚Äì Adventskalender 1.‚Äì24. Dezember</title>
  <meta name="description" content="Digitaler Adventskalender (1.‚Äì24.12.) f√ºr The Kitchen in Lahr ‚Äì mit t√§glichen √úberraschungen und Gewinnspiel-Anmeldung." />
  <style>
    :root{
      --bg:#0b0f1a;
      --card:#121826;
      --ink:#f3f4f6;
      --muted:#a1a1aa;
      --accent:#f59e0b;
      --green:#22c55e;
      --danger:#ef4444;
      --stroke:#243047;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0f1628,#0b111f);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:grid;gap:8px;margin:8px 0 16px}
    header .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:14px;background:#0b1226;border:1px solid #1f2937;display:grid;place-items:center;box-shadow:0 6px 28px rgba(0,0,0,.25)}
    h1{margin:0;font-size:clamp(22px,2.6vw,34px)}
    .sub{color:var(--muted);font-size:14px}
    .btn{appearance:none;border:1px solid #334155;background:#0b1226;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{background:#111b31}
    .btn.ghost{background:transparent}
    .btn.green{background:var(--green);border-color:transparent;color:#05250f}
    .panel{background:rgba(255,255,255,.04);border:1px solid #1f2937;border-radius:18px;padding:14px}
    .two{display:grid;gap:16px}
    @media(min-width:900px){.two{grid-template-columns:1.6fr 1fr}}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(3,1fr);margin:10px 0 24px}
    @media(min-width:680px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(6,1fr)}}
    .tile{position:relative;background:radial-gradient(120% 120% at 100% 0%, #17223f 0%, #0e142a 55%, #0b1226 100%);border:1px solid #1f2937;border-radius:14px;min-height:110px;display:grid;place-items:center;padding:10px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .tile:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .tile .day{position:absolute;top:8px;left:8px;font-size:12px;color:#cbd5e1;background:#0b1226;border:1px solid #1f2937;border-radius:999px;padding:3px 7px}
    .tile .gift{font-weight:700;text-align:center;padding:0 6px}
    .tile.empty .gift{color:var(--muted);font-weight:600}
    .tile.locked{outline:2px dashed #334155}
    .icon{width:54px;height:54px;opacity:.28}
    .legend{font-size:12px;color:var(--muted)}
    dialog{border:none;border-radius:18px;background:#0b1226;color:var(--ink);width:min(720px,92vw);box-shadow:0 30px 80px rgba(0,0,0,.55)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid #1f2937}
    .modal-body{display:grid;gap:14px;padding:16px 18px}
    .row{display:grid;gap:8px}
    label{font-size:12px;color:#cbd5e1}
    input[type="text"], input[type="email"], textarea{width:100%;background:#0f172a;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;color:var(--ink)}
    textarea{min-height:88px;resize:vertical}
    .thumb{width:100%;aspect-ratio:16/10;background:#0f172a;border:1px dashed #334155;border-radius:14px;display:grid;place-items:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .badge{background:#0b1226;border:1px solid #334155;border-radius:999px;padding:8px 12px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;border:1px solid #334155;border-radius:12px;padding:8px 12px;color:#cbd5e1;font-size:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none}
    .toast.show{display:block}
    @keyframes tada{0%{transform:scale(1)}10%{transform:scale(.92) rotate(-2deg)}20%{transform:scale(1.02) rotate(2deg)}30%{transform:scale(.98) rotate(-1deg)}40%{transform:scale(1.01) rotate(1deg)}60%{transform:scale(1)}100%{transform:scale(1)}} .tada{animation:tada .6s ease}
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-3px)}80%{transform:translateX(3px)}} .shake{animation:shake .5s ease}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <div class="brand">
          <div class="logo" aria-hidden="true"><span>üçΩÔ∏è</span></div>
          <div>
            <h1>Adventskalender 1.‚Äì24. Dezember</h1>
            <div class="sub">Restaurant The Kitchen ¬∑ Kirchstra√üe 6, 77933 Lahr/Schwarzwald ¬∑ Tel. <a href="tel:078219210747">07821 9210747</a></div>
            <div class="sub">Deutsches Restaurant ¬∑ 20‚Äì30 ‚Ç¨ ¬∑ Sitzpl√§tze im Freien ¬∑ Hochst√ºhle</div>
          </div>
        </div>
        <div class="row" style="gap:8px">
          <button id="editToggle" class="btn ghost" aria-pressed="false">‚úèÔ∏è Bearbeitungsmodus</button>
          <button id="exportDays" class="btn">‚¨áÔ∏è Kalender exportieren (JSON)</button>
          <label class="btn" for="importDays">‚¨ÜÔ∏è Kalender importieren (JSON)</label>
          <input id="importDays" type="file" accept="application/json" hidden />
        </div>
      </div>
      <div class="legend">Im <strong>Bearbeitungsmodus</strong> kannst du f√ºr jedes T√ºrchen Titel, Beschreibung und ein Foto hinzuf√ºgen (lokal gespeichert). Gewinnspiel-Anmeldungen werden zus√§tzlich zentral gez√§hlt.</div>
    </header>

    <section class="panel two">
      <div>
        <h2>üéÑ Adventskalender</h2>
        <div id="calendar" class="grid" role="list" aria-label="Adventskalender 1 bis 24"></div>
      </div>
      <div>
        <h2>üéÅ Gewinnspiel: Essen f√ºr 4 Personen</h2>
        <div class="kpi">
          <div class="badge" id="kpiRegs">0 Anmeldungen</div>
          <div class="badge" id="kpiOpens">0 T√ºrchen-√ñffnungen</div>
        </div>
        <p>Unter allen registrierten Teilnehmer:innen verlosen wir ein <strong>Essen f√ºr 4 Personen</strong>. Teilnahme bis einschlie√ülich <strong>24.12.</strong></p>
        <form id="raffleForm" class="modal-body panel" style="padding:12px">
          <div class="row">
            <label for="name">Name</label>
            <input id="name" type="text" placeholder="Vor- und Nachname" required />
          </div>
          <div class="row">
            <label for="email">E-Mail</label>
            <input id="email" type="email" placeholder="name@example.com" required />
          </div>
          <div class="row">
            <label class="small"><input id="consent" type="checkbox" required /> Ich bin einverstanden, dass meine Daten zur Durchf√ºhrung des Gewinnspiels gespeichert und verwendet werden.</label>
          </div>
          <button class="btn green" type="submit">Jetzt teilnehmen</button>
          <span id="status" class="small" style="margin-left:10px"></span>

          <div id="adminControls" style="display:none; margin-top:12px">
            <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
              <button id="exportCsv" class="btn" type="button">Teilnehmende exportieren (CSV)</button>
              <button id="drawWinner" class="btn" type="button">üéâ Gewinner ziehen</button>
            </div>
            <div id="winnerBox" class="small" style="margin-top:8px"></div>
          </div>
        </form>
      </div>
    </section>
  </div>

  <dialog id="dayModal">
    <form method="dialog">
      <div class="modal-head">
        <strong id="modalTitle">Tag</strong>
        <div class="row" style="gap:8px">
          <button id="saveDay" class="btn green" value="save">Speichern</button>
          <button class="btn" value="close">Schlie√üen</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row">
          <label for="dayTitle">Titel</label>
          <input id="dayTitle" type="text" placeholder="z.‚ÄØB. Hausgemachter Apfelstrudel" />
        </div>
        <div class="row">
          <label for="dayDesc">Beschreibung</label>
          <textarea id="dayDesc" placeholder="Kurzer Text zum Geschenk / zur √úberraschung"></textarea>
        </div>
        <div class="row">
          <label for="dayImage">Foto (optional)</label>
          <div class="thumb" id="thumb"><span>Kein Bild ‚Äì hier klicken oder unten Datei w√§hlen</span></div>
          <input id="dayImage" type="file" accept="image/*" />
        </div>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const STORAGE_KEY_DAYS='kitchenAdventDays.v1';
    const STORAGE_KEY_REGS='kitchenAdventRegistrations.v1';
    const STORAGE_KEY_OPENED='kitchenOpenedDays.v1';
    const ENDPOINT='https://script.google.com/macros/s/AKfycbzq6N3qIdb0_9rVj5e6vXQCdPIrwBzjhmzh4Kp7AJ6Uns6VpKPc7QbFxtr6aK7fUQBLZQ/exec';

    function defaultDays(){
      const arr=new Array(24).fill(null).map(()=>({title:'',desc:'',imageDataUrl:null}));
      arr[0]={title:'Rigatoni mit H√§hnchenfleisch',desc:'Eine Portion Rigatoni mit H√§hnchenfleisch ‚Äì unser Geschenk am 1. Dezember! üçù',imageDataUrl:null};
      return arr;
    }
    function loadDays(){try{const raw=localStorage.getItem(STORAGE_KEY_DAYS);if(!raw)return defaultDays();const p=JSON.parse(raw);if(!Array.isArray(p)||p.length!==24)return defaultDays();return p.map(d=>({title:d.title||'',desc:d.desc||'',imageDataUrl:d.imageDataUrl||null}));}catch(e){return defaultDays();}}
    function saveDays(d){localStorage.setItem(STORAGE_KEY_DAYS,JSON.stringify(d));}
    function loadOpened(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY_OPENED)||'[]');}catch(e){return[];}}
    function saveOpened(list){localStorage.setItem(STORAGE_KEY_OPENED,JSON.stringify(list));}

    const calendarEl=document.getElementById('calendar');
    const editToggle=document.getElementById('editToggle');
    const dayModal=document.getElementById('dayModal');
    const modalTitle=document.getElementById('modalTitle');
    const dayTitle=document.getElementById('dayTitle');
    const dayDesc=document.getElementById('dayDesc');
    const dayImage=document.getElementById('dayImage');
    const thumb=document.getElementById('thumb');
    const saveDayBtn=document.getElementById('saveDay');
    const toast=document.getElementById('toast');
    const kpiRegs=document.getElementById('kpiRegs');
    const kpiOpens=document.getElementById('kpiOpens');

    let days=loadDays();
    let opened=loadOpened();
    let editMode=false;
    let currentIndex=0;

    function placeholderIcon(){
      return '<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" opacity=".35"/><path d="M9 9a3 3 0 116 0c0 1.657-1.5 2-3 3-1.5-1-3-1.343-3-3z" fill="currentColor" opacity=".35"/><circle cx="12" cy="17" r="1.2" fill="currentColor" opacity=".5"/></svg>';
    }
    function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));}
    function showToast(msg){toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1800);}

    function renderCalendar(){
      calendarEl.innerHTML='';
      const today=new Date();
      const todayDecDay=(today.getMonth()===11)?today.getDate():null;
      days.forEach((d,idx)=>{
        const day=idx+1;
        const tile=document.createElement('button');
        const isEmpty=!(d.title||d.imageDataUrl);
        const isLocked=!editMode && (todayDecDay===null || day!==todayDecDay);
        tile.className='tile'+(isEmpty?' empty':'')+(isLocked?' locked':'');
        tile.setAttribute('role','listitem');
        tile.innerHTML=`<span class="day">${String(day).padStart(2,'0')}.12.</span>${isEmpty?placeholderIcon():''}<div class="gift">${d.title?escapeHtml(d.title):'√úberraschung √∂ffnen'}</div>`;
        tile.addEventListener('click',()=>openDay(idx,tile,isLocked));
        calendarEl.appendChild(tile);
      });
      kpiOpens.textContent=`${opened.length} T√ºrchen-√ñffnungen`;
    }

    function openDay(index,tile,isLocked){
      if(isLocked){showToast(`T√ºrchen ${index+1} ist am ${String(index+1).padStart(2,'0')}.12. verf√ºgbar.`);tile.classList.add('shake');setTimeout(()=>tile.classList.remove('shake'),600);return;}
      if(!editMode && opened.includes(index)){showToast('Dieses T√ºrchen hast du heute schon ge√∂ffnet.');tile.classList.add('shake');setTimeout(()=>tile.classList.remove('shake'),500);return;}
      currentIndex=index; const d=days[index];
      modalTitle.textContent=`T√ºrchen ${index+1}`;
      const canEdit=editMode;
      dayTitle.disabled=!canEdit; dayDesc.disabled=!canEdit; dayImage.disabled=!canEdit;
      dayTitle.value=d.title||''; dayDesc.value=d.desc||''; renderThumb(d.imageDataUrl);
      saveDayBtn.style.display=canEdit?'inline-block':'none';
      tile.classList.add('tada'); setTimeout(()=>tile.classList.remove('tada'),700);
      dayModal.showModal();
      if(!editMode){opened.push(index);opened=[...new Set(opened)];saveOpened(opened);kpiOpens.textContent=`${opened.length} T√ºrchen-√ñffnungen`;}
    }
    function renderThumb(dataUrl){thumb.innerHTML=dataUrl?`<img alt="Geschenkfoto" src="${dataUrl}" />`:`<span>Kein Bild ‚Äì hier klicken oder unten Datei w√§hlen</span>`;}

    editToggle.addEventListener('click',()=>{editMode=!editMode;editToggle.setAttribute('aria-pressed',String(editMode));renderCalendar();});
    thumb.addEventListener('click',()=>{if(editMode) dayImage.click();});
    dayImage.addEventListener('change',()=>{const f=dayImage.files&&dayImage.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{renderThumb(e.target.result)};r.readAsDataURL(f);});
    saveDayBtn.addEventListener('click',e=>{if(!editMode)return;e.preventDefault();const d=days[currentIndex];d.title=dayTitle.value.trim();d.desc=dayDesc.value.trim();const imgEl=thumb.querySelector('img');d.imageDataUrl=imgEl?imgEl.src:null;saveDays(days);renderCalendar();dayModal.close();});

    document.getElementById('exportDays').addEventListener('click',()=>{const blob=new Blob([JSON.stringify(days,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='adventskalender-kitchen.json';a.click();setTimeout(()=>URL.revokeObjectURL(url),2000);});
    document.getElementById('importDays').addEventListener('change',ev=>{const file=ev.target.files&&ev.target.files[0];if(!file)return;const r=new FileReader();r.onload=e=>{try{const p=JSON.parse(e.target.result);if(Array.isArray(p)&&p.length===24){days=p.map(d=>({title:d.title||'',desc:d.desc||'',imageDataUrl:d.imageDataUrl||null}));saveDays(days);renderCalendar();}else{alert('Ung√ºltiges Format. Erwartet 24 Eintr√§ge.');}}catch(err){alert('Konnte Datei nicht lesen.');}};r.readAsText(file);});

    // Registrierung + Admin
    const raffleForm=document.getElementById('raffleForm');
    const statusEl=document.getElementById('status');
    const adminControls=document.getElementById('adminControls');
    const exportCsvBtn=document.getElementById('exportCsv');
    const drawBtn=document.getElementById('drawWinner');
    const winnerBox=document.getElementById('winnerBox');
    const isAdmin=new URLSearchParams(location.search).get('admin')==='kitchen2025';
    if(isAdmin&&adminControls){adminControls.style.display='block';}

    function loadRegs(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY_REGS)||'[]');}catch(e){return[];}}
    function saveRegs(list){localStorage.setItem(STORAGE_KEY_REGS,JSON.stringify(list)); kpiRegs.textContent=`${list.length} Anmeldungen`;}

    function csvField(s){const v=String(s||'');return /[",\n]/.test(v)?'"'+v.replace(/"/g,'""')+'"':v;}

    function renderWinnerBox(){const winners=JSON.parse(localStorage.getItem('kitchenAdventWinners.v1')||'[]');if(winners.length===0){winnerBox.innerHTML='';return;}const items=winners.map(w=>`<li>${escapeHtml(w.name)} ‚Äì ${new Date(w.drawnAt).toLocaleString()}</li>`).join('');winnerBox.innerHTML=`<div class="panel" style="padding:10px"><strong>Gezogene Gewinner</strong><ul>${items}</ul></div>`;}

    raffleForm.addEventListener('submit',async e=>{e.preventDefault();const name=document.getElementById('name').value.trim();const email=document.getElementById('email').value.trim();const consent=document.getElementById('consent').checked; if(!name||!email||!consent){return;}const regs=loadRegs();if(regs.some(r=>r.email.toLowerCase()===email.toLowerCase())){statusEl.textContent='Diese E-Mail ist bereits registriert.';statusEl.style.color='var(--danger)';return;}const payload={name,email,consent:true,source:'the-kitchen-advent',ts:new Date().toISOString()};regs.push(payload);saveRegs(regs);try{await fetch(ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});}catch(err){console.warn('POST fehlgeschlagen',err);}raffleForm.reset();statusEl.textContent='Danke! Deine Teilnahme wurde erfasst.';statusEl.style.color='var(--green)';if(isAdmin) renderWinnerBox();});

    if(isAdmin&&exportCsvBtn){exportCsvBtn.addEventListener('click',()=>{const regs=loadRegs();const header='Name,E-Mail,Datum';const lines=regs.map(r=>`${csvField(r.name)},${csvField(r.email)},${csvField(new Date(r.ts).toLocaleString())}`);const csvStr=[header,...lines].join('\n');const blob=new Blob([csvStr],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='adventskalender-teilnehmende.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),2000);});}
    if(isAdmin&&drawBtn){drawBtn.addEventListener('click',()=>{const regs=loadRegs();if(regs.length===0){alert('Noch keine Anmeldungen.');return;}const winner=regs[Math.floor(Math.random()*regs.length)];const winners=JSON.parse(localStorage.getItem('kitchenAdventWinners.v1')||'[]');winners.push({...winner,drawnAt:new Date().toISOString()});localStorage.setItem('kitchenAdventWinners.v1',JSON.stringify(winners));renderWinnerBox();showToast(`üéâ Gewinner gezogen: ${winner.name}`);});}

    kpiRegs.textContent=`${loadRegs().length} Anmeldungen`; renderCalendar();
  </script>
</body>
</html>