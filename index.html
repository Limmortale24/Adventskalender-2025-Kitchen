<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adventskalender ‚Äì The Kitchen (Lahr)</title>
  <meta name="description" content="Digitaler Adventskalender (1.‚Äì24.12.) f√ºr The Kitchen in Lahr/Schwarzwald ‚Äì mit t√§glichen √úberraschungen und Gewinnspiel-Anmeldung." />
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --ink:#e5e7eb;       /* gray-200 */
      --muted:#a1a1aa;      /* zinc-400 */
      --accent-2:#22c55e;  /* green-500 */
      --danger:#ef4444;    /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#111827, #0b1226);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    a{color:var(--accent)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:grid;gap:12px;margin:8px 0 18px}
    header .top{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:56px;height:56px;border-radius:14px;background:#0b1226;display:grid;place-items:center;border:1px solid #1f2937; box-shadow:0 6px 30px rgba(0,0,0,.25)}
    .brand .logo span{font-weight:800;letter-spacing:.5px}
    h1{font-size:clamp(22px,2.6vw,36px);margin:0}
    .sub{color:var(--muted);font-size:14px}
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    .btn{appearance:none;border:1px solid #1f2937;background:#0b1226;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{background:#0e162f}
    .btn.accent{background:var(--accent);border-color:transparent;color:#111827}
    .btn.green{background:var(--accent-2);border-color:transparent;color:#05250f}
    .btn.ghost{background:transparent;border-color:#334155}

    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:18px 0 28px}
    @media (min-width:900px){.grid{grid-template-columns:repeat(6,1fr)}}
    .tile{position:relative;background:radial-gradient(120% 120% at 100% 0%, #17223f 0%, #0e142a 55%, #0b1226 100%);border:1px solid #1f2937;border-radius:16px;min-height:120px;display:grid;place-items:center;padding:12px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .tile:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .tile .day{position:absolute;top:10px;left:10px;font-size:12px;color:#cbd5e1;background:#0b1226;border:1px solid #1f2937;border-radius:999px;padding:4px 8px}
    .tile .gift{font-weight:700;text-align:center;padding:0 6px}
    .tile.empty .gift{color:var(--muted);font-weight:500}
    .legend{font-size:12px;color:var(--muted);margin-top:-4px}

    .panel{background:rgba(255,255,255,.04);border:1px solid #1f2937;border-radius:18px;padding:16px}
    .two{display:grid;gap:16px}
    @media (min-width:900px){.two{grid-template-columns:1.6fr 1fr}}

    /* Modal */
    dialog{border:none;border-radius:18px;background:#0b1226;color:var(--ink);width:min(720px,92vw);box-shadow:0 30px 80px rgba(0,0,0,.55)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;border-bottom:1px solid #1f2937}
    .modal-body{display:grid;gap:14px;padding:16px 18px}
    .row{display:grid;gap:8px}
    label{font-size:12px;color:#cbd5e1}
    input[type="text"], input[type="date"], input[type="email"], textarea{width:100%;background:#0f172a;border:1px solid #243047;border-radius:12px;padding:10px 12px;color:var(--ink)}
    textarea{min-height:88px;resize:vertical}
    .thumb{width:100%;aspect-ratio:16/10;background:#0f172a;border:1px dashed #334155;border-radius:14px;display:grid;place-items:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}

    .form-inline{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .success{color:var(--accent-2)}
    .danger{color:var(--danger)}
    .small{font-size:12px}

    footer{margin:24px 0;color:#cbd5e1}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="top">
        <div class="brand">
          <div class="logo" aria-hidden="true"><span>üçΩÔ∏è</span></div>
          <div>
            <h1>The Kitchen ‚Äì Adventskalender 1.‚Äì24. Dezember</h1>
            <div class="sub">Restaurant The Kitchen ¬∑ Kirchstra√üe 6, 77933 Lahr/Schwarzwald ¬∑ Tel. <a href="tel:078219210747">07821 9210747</a></div>
            <div class="sub">Deutsches Restaurant ¬∑ 20‚Äì30 ‚Ç¨ ¬∑ Sitzpl√§tze im Freien ¬∑ Hochst√ºhle</div>
          </div>
        </div>
        <div class="actions">
          <button id="editToggle" class="btn ghost" aria-pressed="false">‚úèÔ∏è Bearbeitungsmodus</button>
          <button id="exportDays" class="btn">‚¨áÔ∏è Kalender exportieren (JSON)</button>
          <label class="btn" for="importDays">‚¨ÜÔ∏è Kalender importieren (JSON)</label>
          <input id="importDays" type="file" accept="application/json" hidden />
        </div>
      </div>
      <div class="legend">Tipp: Im <strong>Bearbeitungsmodus</strong> kannst du f√ºr jedes T√ºrchen Titel, Beschreibung und ein Foto hinzuf√ºgen. Alles wird nur lokal im Browser gespeichert (localStorage) und kann als JSON gesichert/geladen werden.</div>
    </header>

    <section class="panel two">
      <div>
        <h2>üéÑ Adventskalender</h2>
        <div id="calendar" class="grid" role="list" aria-label="Adventskalender 1 bis 24"></div>
      </div>
      <div>
        <h2>üéÅ Gewinnspiel: Essen f√ºr 4 Personen</h2>
        <p>Unter allen registrierten Teilnehmer:innen verlosen wir ein <strong>Essen f√ºr 4 Personen</strong> bei uns im Restaurant. Teilnahme bis einschlie√ülich <strong>24.12.</strong></p>
        <form id="raffleForm" class="modal-body panel" style="padding:12px">
          <div class="row">
            <label for="name">Name</label>
            <input id="name" type="text" placeholder="Vor- und Nachname" required />
          </div>
          <div class="row">
            <label for="email">E-Mail</label>
            <input id="email" type="email" placeholder="name@example.com" required />
          </div>
          <div class="row">
            <label class="small"><input id="consent" type="checkbox" required /> Ich bin einverstanden, dass meine Daten zur Durchf√ºhrung des Gewinnspiels gespeichert und verwendet werden.</label>
          </div>
          <div class="form-inline">
            <button class="btn green" type="submit">Jetzt teilnehmen</button>
            <span id="status" class="small muted" aria-live="polite"></span>
          </div>
          <div class="small muted">Hinweis: Deine Daten werden nur f√ºr die Durchf√ºhrung des Gewinnspiels verwendet.</div>

          <!-- Admin-Bereich: wird nur angezeigt, wenn die Seite mit ?admin=kitchen2025 ge√∂ffnet wird -->
          <div id="adminControls" style="display:none; margin-top:10px">
            <div class="form-inline">
              <button id="exportCsv" class="btn" type="button">Teilnehmende exportieren (CSV)</button>
              <button id="drawWinner" class="btn accent" type="button">üéâ Gewinner ziehen</button>
              <span id="adminKpi" class="small muted"></span>
            </div>
            <div id="winnerBox" class="small" style="margin-top:8px"></div>
          </div>
        </form>
      </div>
    </section>

    <dialog id="dayModal">
      <form method="dialog">
        <div class="modal-head">
          <strong id="modalTitle">Tag</strong>
          <div class="form-inline">
            <button id="saveDay" class="btn green" value="save">Speichern</button>
            <button class="btn" value="close">Schlie√üen</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="row">
            <label for="dayTitle">Titel</label>
            <input id="dayTitle" type="text" placeholder="z.‚ÄØB. Hausgemachter Apfelstrudel" />
          </div>
          <div class="row">
            <label for="dayDesc">Beschreibung</label>
            <textarea id="dayDesc" placeholder="Kurzer Text zum Geschenk / zur √úberraschung"></textarea>
          </div>
          <div class="row">
            <label for="dayImage">Foto (optional)</label>
            <div class="thumb" id="thumb"><span>Kein Bild ‚Äì hier klicken oder unten Datei w√§hlen</span></div>
            <input id="dayImage" type="file" accept="image/*" />
          </div>
        </div>
      </form>
    </dialog>

    <footer>
      <p class="small">√ñffnungszeiten: Heute ge√∂ffnet, K√ºchenschluss 22:00 ¬∑ Weitere Infos telefonisch oder vor Ort.</p>
      <p class="small">Adresse: Kirchstra√üe 6, 77933 Lahr/Schwarzwald ¬∑ <a href="https://maps.google.com/?q=Kirchstra√üe%206,%2077933%20Lahr%2FSchwarzwald" target="_blank" rel="noopener">Route planen</a></p>
    </footer>

  <section style="text-align:center; margin-top:40px;">
    <h2>üì± QR‚ÄëCode zum Adventskalender</h2>
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://limmortale24.github.io/Adventskalender-2025-Kitchen/" alt="QR-Code f√ºr den Adventskalender The Kitchen 2025" />
    <p>Das ist der QR‚ÄëCode f√ºr den Adventskalender von <strong>The Kitchen 2025</strong>.</p>
  </section>
  </div>

  <script>
    // ------- Datenhaltung -------
    const STORAGE_KEY_DAYS = 'kitchenAdventDays.v1';
    const STORAGE_KEY_REGS = 'kitchenAdventRegistrations.v1'; // lokal ‚Äì zus√§tzlich wird an ENDPOINT gepostet
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzq6N3qIdb0_9rVj5e6vXQCdPIrwBzjhmzh4Kp7AJ6Uns6VpKPc7QbFxtr6aK7fUQBLZQ/exec';

    // ---- FEHLENDE FUNKTIONEN (wiederhergestellt) ----
    function defaultDays(){
      const arr = new Array(24).fill(null).map(()=>({title:'',desc:'',imageDataUrl:null}));
      // 1. Dezember vorbelegen
      arr[0] = { title:'Rigatoni mit H√§hnchenfleisch', desc:'Eine Portion Rigatoni mit H√§hnchenfleisch ‚Äì unser Geschenk am 1. Dezember! üçù', imageDataUrl:null };
      return arr;
    }
    function loadDays(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY_DAYS);
        if(!raw) return defaultDays();
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed) || parsed.length!==24) return defaultDays();
        return parsed.map(d=>({title:d.title||'',desc:d.desc||'',imageDataUrl:d.imageDataUrl||null}));
      }catch(e){ return defaultDays(); }
    }
    function saveDays(days){ localStorage.setItem(STORAGE_KEY_DAYS, JSON.stringify(days)); }

    function loadRegs(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY_REGS)||'[]'); }
      catch(e){ return []; }
    }
    function saveRegs(list){
      localStorage.setItem(STORAGE_KEY_REGS, JSON.stringify(list));
    }

    // ------- UI: Kalender -------
    const calendarEl = document.getElementById('calendar');
    const editToggle = document.getElementById('editToggle');
    const dayModal = document.getElementById('dayModal');
    const modalTitle = document.getElementById('modalTitle');
    const dayTitle = document.getElementById('dayTitle');
    const dayDesc = document.getElementById('dayDesc');
    const dayImage = document.getElementById('dayImage');
    const thumb = document.getElementById('thumb');
    const saveDayBtn = document.getElementById('saveDay');

    let days = loadDays();
    let editMode = false;
    let currentIndex = 0;

    function renderCalendar(){
      calendarEl.innerHTML='';
      days.forEach((d,idx)=>{
        const day = idx+1;
        const tile = document.createElement('button');
        tile.className = 'tile' + ((d.title||d.imageDataUrl)?'':' empty');
        tile.setAttribute('role','listitem');
        tile.innerHTML = `
          <span class="day">${String(day).padStart(2,'0')}.12.</span>
          <div class="gift">${d.title ? escapeHtml(d.title) : '√úberraschung √∂ffnen'}</div>
        `;
        tile.addEventListener('click',()=>openDay(idx));
        calendarEl.appendChild(tile);
      });
    }

    function openDay(index){
      currentIndex = index;
      const d = days[index];
      modalTitle.textContent = `T√ºrchen ${index+1}`;

      const canEdit = editMode;
      dayTitle.disabled = !canEdit;
      dayDesc.disabled = !canEdit;
      dayImage.disabled = !canEdit;

      dayTitle.value = d.title || '';
      dayDesc.value = d.desc || '';
      renderThumb(d.imageDataUrl);

      if(!canEdit){ saveDayBtn.style.display='none'; }
      else { saveDayBtn.style.display='inline-block'; }

      dayModal.showModal();
    }

    function renderThumb(dataUrl){
      if(dataUrl){
        thumb.innerHTML = `<img alt="Geschenkfoto" src="${dataUrl}" />`;
      } else {
        thumb.innerHTML = `<span>Kein Bild ‚Äì hier klicken oder unten Datei w√§hlen</span>`;
      }
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    editToggle.addEventListener('click', ()=>{
      editMode = !editMode;
      editToggle.setAttribute('aria-pressed', String(editMode));
      editToggle.classList.toggle('accent', editMode);
      renderCalendar();
    });

    thumb.addEventListener('click', ()=>{ if(editMode) dayImage.click(); });

    dayImage.addEventListener('change', ()=>{
      const file = dayImage.files && dayImage.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        renderThumb(e.target.result);
      };
      reader.readAsDataURL(file);
    });

    saveDayBtn.addEventListener('click', (e)=>{
      if(!editMode) return;
      e.preventDefault();
      const d = days[currentIndex];
      d.title = dayTitle.value.trim();
      d.desc = dayDesc.value.trim();
      const imgEl = thumb.querySelector('img');
      d.imageDataUrl = imgEl ? imgEl.src : null;
      saveDays(days);
      renderCalendar();
      dayModal.close();
    });

    // Export / Import Days
    document.getElementById('exportDays').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(days,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'adventskalender-kitchen.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });
    document.getElementById('importDays').addEventListener('change', (ev)=>{
      const file = ev.target.files && ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const parsed = JSON.parse(e.target.result);
          if(Array.isArray(parsed) && parsed.length===24){
            days = parsed.map(d=>({title:d.title||'',desc:d.desc||'',imageDataUrl:d.imageDataUrl||null}));
            saveDays(days);
            renderCalendar();
          } else { alert('Ung√ºltiges Format. Erwartet 24 Eintr√§ge.'); }
        }catch(err){ alert('Konnte Datei nicht lesen.'); }
      };
      reader.readAsText(file);
    });

    // ------- Registrierung -------
    const raffleForm = document.getElementById('raffleForm');
    const statusEl = document.getElementById('status');
    const adminControls = document.getElementById('adminControls');
    const exportCsvBtn = document.getElementById('exportCsv');
    const drawBtn = document.getElementById('drawWinner');
    const winnerBox = document.getElementById('winnerBox');
    const adminKpi = document.getElementById('adminKpi');

    const isAdmin = new URLSearchParams(location.search).get('admin') === 'kitchen2025';
    if(isAdmin && adminControls){ adminControls.style.display = 'block'; }

    function updateStatus(){
      if(isAdmin){
        const regs = loadRegs();
        adminKpi.textContent = `${regs.length} Anmeldungen`;
        renderWinnerBox();
      }
    }

    raffleForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const consent = document.getElementById('consent').checked;
      if(!name || !email || !consent){ return; }
      const regs = loadRegs();
      if(regs.some(r=>r.email.toLowerCase()===email.toLowerCase())){
        statusEl.textContent = 'Diese E-Mail ist bereits registriert.';
        statusEl.className = 'small danger';
        return;
      }
      const payload = {name, email, consent:true, source:'the-kitchen-advent', ts:new Date().toISOString()};
      regs.push(payload);
      saveRegs(regs);
      try{ await fetch(ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); }
      catch(err){ console.warn('POST fehlgeschlagen', err); }
      raffleForm.reset();
      statusEl.textContent = 'Danke! Deine Teilnahme wurde erfasst.';
      statusEl.className = 'small success';
      setTimeout(updateStatus, 800);
    });

    if(exportCsvBtn){
      exportCsvBtn.addEventListener('click', ()=>{
        const regs = loadRegs();
        const header = 'Name,E-Mail,Datum';
        const lines = regs.map(r => `${csv(r.name)},${csv(r.email)},${csv(new Date(r.ts).toLocaleString())}`);
        const csvStr = [header, ...lines].join('
');
        const winners = JSON.parse(localStorage.getItem('kitchenAdventWinners.v1')||'[]');
        winners.push({ ...winner, drawnAt: new Date().toISOString() });
        localStorage.setItem('kitchenAdventWinners.v1', JSON.stringify(winners));
        renderWinnerBox();
        statusEl.textContent = `üéâ Gewinner gezogen: ${winner.name}`;
        statusEl.className = 'small success';
      });
    }

    function renderWinnerBox(){
      const winners = JSON.parse(localStorage.getItem('kitchenAdventWinners.v1')||'[]');
      if(!winnerBox) return;
      if(winners.length===0){ winnerBox.innerHTML = ''; return; }
      const items = winners.map(w => `<li>${escapeHtml(w.name)} ‚Äì ${new Date(w.drawnAt).toLocaleString()}</li>`).join('');
      winnerBox.innerHTML = `<div class=\"panel\" style=\"padding:10px\"><strong>Gezogene Gewinner</strong><ul>${items}</ul></div>`;
    }

    function csv(s){
      const v = String(s||'');
      if(/[",
]/.test(v)) return '"'+v.replace(/"/g,'""')+'"';
      return v;
    }

    // Init
    renderCalendar();
    updateStatus();
  </script>
</body>
</html>
